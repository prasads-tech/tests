name: Automation Pipeline

on:
  push:
    branches:
      - main
    paths:
      - "**/*.json"  # Trigger the workflow on any JSON file change

jobs:
  process_json_files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up jq
        run: sudo apt-get install -y jq

      - name: List and Process JSON Files
        id: process_json_files
        run: |
          # Change to the directory containing JSON files
          cd Clusters-Dev/AKS/Input/

          # Find all JSON files and print their modification time and path
          find . -name '*.json' -print0 | while IFS= read -r -d '' FILE; do
            # Extract the modification time and path
            MOD_TIME=$(stat -c '%Y' "$FILE")
            echo "$MOD_TIME $FILE"
          done | sort -nr | head -n 1 | while read -r MOD_TIME FILE; do
            echo "Newly modified or added JSON file: ${FILE#./}"

            # Read the JSON file content and extract CLUSTER_NAME
            CLUSTER_NAME=$(jq -r '.CLUSTER_NAME' "$FILE")
            echo "Cluster Name in ${FILE#./}: $CLUSTER_NAME"

            # Set the environment variable for GitHub Actions
            echo "INPUT_PATH=${FILE#./}" >> $GITHUB_ENV
            echo "CLUSTER_NAME=$CLUSTER_NAME" >> $GITHUB_ENV
          done
        shell: bash

      - name: Use the Extracted CLUSTER_NAME
        if: env.INPUT_PATH != ''
        run: |
          echo "Processing file: $INPUT_PATH"
          echo "Cluster Name: $CLUSTER_NAME"

          # Replace this with the actual command you want to run
          # For example: python your_script.py --cluster "$CLUSTER_NAME" --file "$INPUT_PATH"
          echo "Running command with cluster name: $CLUSTER_NAME and file: $INPUT_PATH"
