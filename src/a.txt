name: Process Uploaded JSON Files

on:
  push:
    paths:
      - 'Clusters-Dev/AKS/Workload/Input/*.json'

jobs:
  process-json-files:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v2

      # Step 2: Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # Step 3: Get new/modified JSON files
      - name: Get list of newly added JSON files
        id: get-files
        run: |
          # Find all new/modified JSON files in the Input folder
          json_files=$(git diff --name-only HEAD^ HEAD | grep 'Clusters-Dev/AKS/Workload/Input/.*\.json')

          # Check if there are new files
          if [[ -z "$json_files" ]]; then
            echo "No new JSON files detected."
            exit 1
          fi

          # Save the JSON files as space-separated paths to use in the next steps
          echo "json_files=$json_files" >> $GITHUB_ENV

      # Step 4: Install dependencies
      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # Step 5: Run the Python script with the new JSON files as input
      - name: Execute the Python script with the new JSON files
        run: |
          python final.py --input $json_files

      # Step 6: Commit and push any changes (like output files)
      - name: Commit and push changes
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add .
          git commit -m "Processed new JSON input files: $json_files"
          git push
