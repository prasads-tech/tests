name: Generate Cluster Definitions

on:
  workflow_dispatch:
    inputs:
      input_path:
        description: 'Path to the input JSON file'
        required: true
      mapping_path:
        description: 'Path to the mapping JSON file'
        required: true
      template_path:
        description: 'Path to the YAML template file'
        required: true

jobs:
  generate_definitions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Python script with user inputs
        run: |
          python main.py --input "${{ github.event.inputs.input_path }}" \
                         --mapping "${{ github.event.inputs.mapping_path }}" \
                         --template "${{ github.event.inputs.template_path }}"

      - name: Generate Branch Name
        id: generate_branch_name
        run: |
          # Extract the file name from the input path and sanitize it
          INPUT_FILE="${{ github.event.inputs.input_path }}"
          BRANCH_NAME=$(echo "${INPUT_FILE}" | sed 's/[^a-zA-Z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//')
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install gh -y

      - name: Commit and Push changes
        run: |
          git config user.name "prasad-vm"
          git config user.email "actions@github.com"
          git checkout -b "feature/${{ env.BRANCH_NAME }}"
          git add path/to/output_directory
          git commit -m "Add generated files"
          git push origin "feature/${{ env.BRANCH_NAME }}"

      - name: Create Pull Request
        run: |
          gh auth login --with-token < ${{ secrets.GITHUB_TOKEN }}
          gh pr create --base main --head "feature/${{ env.BRANCH_NAME }}" \
                       --title "Automated PR: Update generated files" \
                       --body "This PR includes the latest generated files from the workflow."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
