- name: Trigger new pipeline using GitHub App
  env:
    APP_ID: ${{ secrets.GITHUB_APP_ID }}
    PRIVATE_KEY: ${{ secrets.GITHUB_APP_PRIVATE_KEY }}
  run: |
    # Install necessary tools
    pip install PyJWT

    # Generate JWT token using GitHub App private key
    echo "Generating JWT token..."
    JWT_TOKEN=$(python3 -c "
import jwt, time
payload = {
  'iat': int(time.time()),
  'exp': int(time.time()) + 600,
  'iss': '${APP_ID}'
}
private_key = '''${PRIVATE_KEY}'''
print(jwt.encode(payload, private_key, algorithm='RS256'))
")

    echo "Triggering new workflow via API..."
    curl -X POST -H "Authorization: Bearer $JWT_TOKEN" \
         -H "Accept: application/vnd.github.v3+json" \
         https://api.github.com/repos/ValueMomentum-Inc/GEICOPOC-Spec/dispatches \
         -d '{"event_type": "trigger_new_pipeline"}'



      - name: Fetch and Check for Changes
        id: check_files
        run: |
          git fetch origin main
          CHANGED_FILES=$(git diff --name-only HEAD origin/main | grep 'Clusters-Dev/AKS/Workload/')
          if [ -n "$CHANGED_FILES" ]; then
            echo "Changed files detected: $CHANGED_FILES"
            echo "FILES_CHANGED=true" >> $GITHUB_ENV
          else
            echo "No changes detected."
            echo "FILES_CHANGED=false" >> $GITHUB_ENV
          fi

      - name: Create Trigger File if Changes Detected
        if: env.FILES_CHANGED == 'true'
        run: |
          echo "Changes detected. Creating trigger file..."
          mkdir -p .trigger
          touch .trigger/trigger-file.txt
          git add .trigger/trigger-file.txt
          git commit -m "Add trigger file for second workflow"
          git push
