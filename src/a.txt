name: Process JSON Files in Batches

on:
  push:
    paths:
      - 'Clusters-Dev/AKS/Workload/Input/*.json'
      - 'Clusters-NonProd/AKS/Workload/Input/*.json'
      - 'Clusters-Prod/AKS/Workload/Input/*.json'

jobs:
  batch-processing:
    runs-on: ubuntu-latest

    # Step 1: Get all modified files
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Get modified JSON files
        id: get-files
        run: |
          # Get list of modified files
          files=$(git diff --name-only HEAD^ HEAD | grep 'Clusters-Dev/AKS/Workload/Input/.*\.json')
          
          # Save files to a JSON array (to be used in the matrix)
          echo "changed_files=$(jq -nR '[inputs]' <<<"$files")" >> $GITHUB_ENV

    # Step 2: Process JSON files in batches using a matrix
    strategy:
      matrix:
        file-batch: ${{ fromJson(env.changed_files) }}
        # Limiting the number of parallel jobs
        max-parallel: 5

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Process JSON file
        run: |
          echo "Processing file: ${{ matrix.file-batch }}"
          # Run your Python script for each input file
          python final.py --input ${{ matrix.file-batch }}

      - name: Copy Output to Workload Directory
        run: |
          cp -r output/* Clusters-Dev/AKS/Workload/
      
      - name: Commit and Push Changes
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add Clusters-Dev/AKS/Workload/
          git commit -m "Processed output for ${{ matrix.file-batch }}"
          git push origin

  # Step 3: Create a PR for merging changes
  create-pr:
    needs: batch-processing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          branch: json-output
          commit-message: "Processed output files"
          title: "Processed JSON Input Files"
          body: "Generated output from newly added JSON files."
          labels: ["json-processing", "automation"]
